version: 2.1
jobs:
  build:
    docker:
      - image: cimg/python:3.8  # Using Python image since AWS CLI needs Python
    steps:
      - checkout
      - run:
          name: Install AWS CLI
          command: |
            sudo apt update
            sudo apt install -y awscli
            aws --version  # Verify installation
      - run:
          name: Build Debug APK
          command: ./gradlew assembleDebug
      - run:
          name: Upload APK to AWS S3
          command: |
            APK_NAME="app-debug-$(date +%F-%H-%M-%S).apk"
            aws s3 cp app/build/outputs/apk/debug/app-debug.apk s3://$S3_BUCKET_NAME/$APK_NAME
      - run:
          name: Send Slack Notification with APK Link
          command: |
            TIMESTAMP=$(date +"%A, %B %d, %Y %I:%M %p")
            APK_NAME="app-debug-$(date +%F-%H-%M-%S).apk"
            APK_URL="https://$S3_BUCKET_NAME.s3.$AWS_REGION.amazonaws.com/$APK_NAME"
            MESSAGE="âœ… *APK Build Completed!*\nðŸ“… Build Date: $TIMESTAMP\nðŸ“‚ *Download APK:* <$APK_URL|Click Here>\nðŸ”— CircleCI Build: $CIRCLE_BUILD_URL"
            curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MESSAGE}\"}" \
            "$SLACK_WEBHOOK_URL"
